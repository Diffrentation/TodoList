# Environment Variables Setup - Changes Summary

## What Was Updated

### 1. Created Environment Template Files
- ✅ `env.template` - Template file for environment variables (can be committed to git)
- ✅ Created setup script `scripts/setup-env.js` for automatic environment setup

### 2. Updated Code for Better Environment Variable Handling

#### Fixed Cookie Security Settings
- Updated all cookie settings to handle `NODE_ENV` with default fallback
- Files updated:
  - `src/app/api/auth/login/route.js`
  - `src/app/api/auth/login-otp/route.js`
  - `src/app/api/auth/refresh-token/route.js`

#### Fixed Email Transporter
- Updated `src/lib/email.js` to handle missing SMTP credentials gracefully
- Email auth is now conditional (only set if credentials provided)

#### Fixed Authentication Middleware
- Updated `src/lib/middleware/auth.js` to properly handle cookies parameter
- Fixed `requireRole` function to accept cookies parameter

### 3. Added Setup Script
- ✅ `npm run setup-env` command added to `package.json`
- Automatically generates secure JWT secrets
- Creates `.env.local` from template

### 4. Updated Documentation
- ✅ `SETUP.md` - Updated with new setup instructions
- ✅ `README.md` - Updated environment setup section
- ✅ `ENV_VARIABLES.md` - Comprehensive environment variables reference

## Environment Variables Required

### Required (Must be set)
1. `MONGODB_URI` - MongoDB connection string
2. `JWT_SECRET` - Secret for access tokens (auto-generated by setup script)
3. `JWT_REFRESH_SECRET` - Secret for refresh tokens (auto-generated by setup script)

### Optional (Has defaults or works without)
1. `SMTP_HOST` - Default: `smtp.gmail.com`
2. `SMTP_PORT` - Default: `587`
3. `SMTP_USER` - Optional, OTPs logged to console if not set
4. `SMTP_PASS` - Optional, OTPs logged to console if not set
5. `NODE_ENV` - Default: `development`

## Quick Start

1. **Run setup script:**
   ```bash
   npm run setup-env
   ```

2. **Update MongoDB URI in `.env.local`:**
   ```env
   MONGODB_URI=mongodb://localhost:27017/todolist
   ```

3. **Optionally configure email (for production):**
   ```env
   SMTP_USER=your-email@gmail.com
   SMTP_PASS=your-app-password
   ```

4. **Start the application:**
   ```bash
   npm run dev
   ```

## Key Improvements

1. **Automatic Secret Generation** - JWT secrets are auto-generated with secure random values
2. **Graceful Degradation** - App works without email configuration (OTPs in console)
3. **Better Error Handling** - Environment variables have sensible defaults
4. **Production Ready** - Proper handling of `NODE_ENV` for cookie security
5. **Developer Friendly** - Clear setup process and documentation

## Files Created/Modified

### Created:
- `env.template` - Environment variables template
- `scripts/setup-env.js` - Automatic setup script
- `ENV_VARIABLES.md` - Environment variables documentation
- `CHANGELOG_ENV.md` - This file

### Modified:
- `package.json` - Added `setup-env` script
- `src/lib/middleware/auth.js` - Fixed cookies parameter handling
- `src/lib/email.js` - Conditional email auth
- `src/app/api/auth/login/route.js` - Fixed NODE_ENV handling
- `src/app/api/auth/login-otp/route.js` - Fixed NODE_ENV handling
- `src/app/api/auth/refresh-token/route.js` - Fixed NODE_ENV handling
- `SETUP.md` - Updated setup instructions
- `README.md` - Updated environment setup section

## Testing

After setup, verify:
1. `.env.local` file exists
2. JWT secrets are generated (not placeholder values)
3. MongoDB URI is set correctly
4. Application starts without errors
5. OTPs appear in console if email not configured

## Next Steps

1. Update `MONGODB_URI` with your actual MongoDB connection string
2. (Optional) Configure email for OTP delivery
3. Run `npm run dev` to start development server
4. Test registration flow - OTP should appear in console if email not configured

